import { pgTable, text, decimal, timestamp, boolean, index } from 'drizzle-orm/pg-core';
import { relations } from 'drizzle-orm';

// ==================== MASTERS ====================

export const rawMaterials = pgTable('raw_materials', {
    id: text('id').primaryKey().$defaultFn(() => crypto.randomUUID()),
    code: text('code').notNull().unique(),
    name: text('name').notNull(),
    size: text('size').default('Standard'),
    color: text('color').notNull(),
    unit: text('unit').default('kg'),
    hsnCode: text('hsn_code').default('3901'),
    gstPercent: decimal('gst_percent', { precision: 5, scale: 2 }).default('18'),
    reorderLevel: decimal('reorder_level', { precision: 10, scale: 2 }).default('100'),
    // NOTE: Price removed - comes from purchase bill only
    // NOTE: Stock removed - calculated from stock movements
    createdAt: timestamp('created_at').defaultNow(),
    updatedAt: timestamp('updated_at').defaultNow(),
});

export const finishedProducts = pgTable('finished_products', {
    id: text('id').primaryKey().$defaultFn(() => crypto.randomUUID()),
    code: text('code').notNull().unique(),
    name: text('name').notNull(),
    length: text('length').notNull(),
    width: text('width').notNull(),
    gsm: text('gsm').notNull(),
    unit: text('unit').default('kg'),
    hsnCode: text('hsn_code').default('5608'),
    gstPercent: decimal('gst_percent', { precision: 5, scale: 2 }).default('18'),
    ratePerKg: decimal('rate_per_kg', { precision: 10, scale: 2 }).default('0'), // Selling rate
    // NOTE: Stock removed - calculated from stock movements
    createdAt: timestamp('created_at').defaultNow(),
    updatedAt: timestamp('updated_at').defaultNow(),
});

export const machines = pgTable('machines', {
    id: text('id').primaryKey().$defaultFn(() => crypto.randomUUID()),
    code: text('code').notNull().unique(),
    name: text('name').notNull(),
    type: text('type').default('Net Extrusion'),
    capacity: text('capacity'),
    status: text('status').default('Active'),
    createdAt: timestamp('created_at').defaultNow(),
    updatedAt: timestamp('updated_at').defaultNow(),
});

export const customers = pgTable('customers', {
    id: text('id').primaryKey().$defaultFn(() => crypto.randomUUID()),
    code: text('code').notNull().unique(),
    name: text('name').notNull(),
    gstNo: text('gst_no'),
    stateCode: text('state_code').default('27'), // Maharashtra = 27
    email: text('email'),
    phone: text('phone').notNull(),
    address: text('address'),
    outstanding: decimal('outstanding', { precision: 10, scale: 2 }).default('0'),
    createdAt: timestamp('created_at').defaultNow(),
    updatedAt: timestamp('updated_at').defaultNow(),
});

export const suppliers = pgTable('suppliers', {
    id: text('id').primaryKey().$defaultFn(() => crypto.randomUUID()),
    code: text('code').notNull().unique(),
    name: text('name').notNull(),
    gstNo: text('gst_no'),
    stateCode: text('state_code').default('27'), // For CGST/SGST vs IGST logic
    contact: text('contact').notNull(),
    address: text('address'),
    outstanding: decimal('outstanding', { precision: 10, scale: 2 }).default('0'),
    createdAt: timestamp('created_at').defaultNow(),
    updatedAt: timestamp('updated_at').defaultNow(),
});

export const expenseHeads = pgTable('expense_heads', {
    id: text('id').primaryKey().$defaultFn(() => crypto.randomUUID()),
    code: text('code').notNull().unique(),
    name: text('name').notNull(),
    category: text('category').default('Variable'),
    createdAt: timestamp('created_at').defaultNow(),
    updatedAt: timestamp('updated_at').defaultNow(),
});

export const bankCashAccounts = pgTable('bank_cash_accounts', {
    id: text('id').primaryKey().$defaultFn(() => crypto.randomUUID()),
    code: text('code').notNull().unique(),
    name: text('name').notNull(),
    accountNo: text('account_no'),
    type: text('type').default('Bank'), // Bank, Cash
    balance: decimal('balance', { precision: 12, scale: 2 }).default('0'),
    createdAt: timestamp('created_at').defaultNow(),
    updatedAt: timestamp('updated_at').defaultNow(),
});

export const employees = pgTable('employees', {
    id: text('id').primaryKey().$defaultFn(() => crypto.randomUUID()),
    code: text('code').notNull().unique(),
    name: text('name').notNull(),
    designation: text('designation').notNull(),
    contact: text('contact').notNull(),
    salary: decimal('salary', { precision: 10, scale: 2 }).notNull(),
    createdAt: timestamp('created_at').defaultNow(),
    updatedAt: timestamp('updated_at').defaultNow(),
});

// ==================== PURCHASE (RAW MATERIAL PURCHASE) ====================

export const purchaseBills = pgTable('purchase_bills', {
    id: text('id').primaryKey().$defaultFn(() => crypto.randomUUID()),
    code: text('code').notNull().unique(),
    date: timestamp('date').notNull(),
    supplierId: text('supplier_id').notNull().references(() => suppliers.id),
    supplierGST: text('supplier_gst'),
    billingAddress: text('billing_address'),
    // Totals
    subtotal: decimal('subtotal', { precision: 12, scale: 2 }).default('0'),
    discountAmount: decimal('discount_amount', { precision: 10, scale: 2 }).default('0'),
    cgst: decimal('cgst', { precision: 10, scale: 2 }).default('0'),
    sgst: decimal('sgst', { precision: 10, scale: 2 }).default('0'),
    igst: decimal('igst', { precision: 10, scale: 2 }).default('0'),
    totalTax: decimal('total_tax', { precision: 10, scale: 2 }).default('0'),
    total: decimal('total', { precision: 12, scale: 2 }).notNull(),
    roundOff: decimal('round_off', { precision: 5, scale: 2 }).default('0'),
    grandTotal: decimal('grand_total', { precision: 12, scale: 2 }).notNull(),
    // Payment
    paidAmount: decimal('paid_amount', { precision: 12, scale: 2 }).default('0'),
    balanceAmount: decimal('balance_amount', { precision: 12, scale: 2 }).default('0'),
    paymentStatus: text('payment_status').default('Unpaid'), // Unpaid, Partial, Paid
    status: text('status').default('Draft'), // Draft, Confirmed, Cancelled
    createdAt: timestamp('created_at').defaultNow(),
    updatedAt: timestamp('updated_at').defaultNow(),
}, (table) => ({
    supplierIdx: index('purchase_bills_supplier_idx').on(table.supplierId),
    dateIdx: index('purchase_bills_date_idx').on(table.date),
    statusIdx: index('purchase_bills_status_idx').on(table.status),
}));

export const purchaseBillItems = pgTable('purchase_bill_items', {
    id: text('id').primaryKey().$defaultFn(() => crypto.randomUUID()),
    billId: text('bill_id').notNull().references(() => purchaseBills.id, { onDelete: 'cascade' }),
    rawMaterialId: text('raw_material_id').notNull().references(() => rawMaterials.id),
    materialName: text('material_name').notNull(),
    hsnCode: text('hsn_code').default('3901'),
    quantity: decimal('quantity', { precision: 10, scale: 2 }).notNull(),
    rate: decimal('rate', { precision: 10, scale: 2 }).notNull(),
    amount: decimal('amount', { precision: 12, scale: 2 }).notNull(),
    gstPercent: decimal('gst_percent', { precision: 5, scale: 2 }).default('18'),
    cgst: decimal('cgst', { precision: 10, scale: 2 }).default('0'),
    sgst: decimal('sgst', { precision: 10, scale: 2 }).default('0'),
    igst: decimal('igst', { precision: 10, scale: 2 }).default('0'),
    totalAmount: decimal('total_amount', { precision: 12, scale: 2 }).notNull(),
    createdAt: timestamp('created_at').defaultNow(),
});

// ==================== PRODUCTION ====================

export const productionBatches = pgTable('production_batches', {
    id: text('id').primaryKey().$defaultFn(() => crypto.randomUUID()),
    code: text('code').notNull().unique(),
    allocationDate: timestamp('allocation_date').notNull(),
    completionDate: timestamp('completion_date'),
    machineId: text('machine_id').notNull().references(() => machines.id),
    rawMaterialId: text('raw_material_id').notNull().references(() => rawMaterials.id),
    finishedProductId: text('finished_product_id').references(() => finishedProducts.id),
    inputQuantity: decimal('input_quantity', { precision: 10, scale: 2 }).notNull(),
    outputQuantity: decimal('output_quantity', { precision: 10, scale: 2 }),
    lossQuantity: decimal('loss_quantity', { precision: 10, scale: 2 }),
    lossPercentage: decimal('loss_percentage', { precision: 5, scale: 2 }),
    lossExceeded: boolean('loss_exceeded').default(false),
    status: text('status').default('in-progress'), // in-progress, completed
    remarks: text('remarks'),
    createdAt: timestamp('created_at').defaultNow(),
    updatedAt: timestamp('updated_at').defaultNow(),
}, (table) => ({
    machineIdx: index('production_batches_machine_idx').on(table.machineId),
    statusIdx: index('production_batches_status_idx').on(table.status),
}));

// ==================== SALES ====================

export const salesInvoices = pgTable('sales_invoices', {
    id: text('id').primaryKey().$defaultFn(() => crypto.randomUUID()),
    invoiceNumber: text('invoice_number').notNull().unique(),
    invoiceDate: timestamp('invoice_date').notNull(),
    dueDate: timestamp('due_date'),
    customerId: text('customer_id').references(() => customers.id), // Nullable for B2C
    customerName: text('customer_name').notNull(), // For B2C walk-in
    customerGST: text('customer_gst'),
    billingAddress: text('billing_address'),
    shippingAddress: text('shipping_address'),
    placeOfSupply: text('place_of_supply').default('Maharashtra'),
    invoiceType: text('invoice_type').default('B2B'), // B2B, B2C
    // Totals
    subtotal: decimal('subtotal', { precision: 12, scale: 2 }).default('0'),
    discountAmount: decimal('discount_amount', { precision: 10, scale: 2 }).default('0'),
    taxableAmount: decimal('taxable_amount', { precision: 12, scale: 2 }).default('0'),
    cgst: decimal('cgst', { precision: 10, scale: 2 }).default('0'),
    sgst: decimal('sgst', { precision: 10, scale: 2 }).default('0'),
    igst: decimal('igst', { precision: 10, scale: 2 }).default('0'),
    totalTax: decimal('total_tax', { precision: 10, scale: 2 }).default('0'),
    roundOff: decimal('round_off', { precision: 5, scale: 2 }).default('0'),
    grandTotal: decimal('grand_total', { precision: 12, scale: 2 }).notNull(),
    // Payment tracking
    paidAmount: decimal('paid_amount', { precision: 12, scale: 2 }).default('0'),
    balanceAmount: decimal('balance_amount', { precision: 12, scale: 2 }).default('0'),
    paymentStatus: text('payment_status').default('Unpaid'), // Unpaid, Partial, Paid
    status: text('status').default('Draft'), // Draft, Confirmed, Cancelled
    createdAt: timestamp('created_at').defaultNow(),
    updatedAt: timestamp('updated_at').defaultNow(),
}, (table) => ({
    customerIdx: index('sales_invoices_customer_idx').on(table.customerId),
    invoiceDateIdx: index('sales_invoices_date_idx').on(table.invoiceDate),
    statusIdx: index('sales_invoices_status_idx').on(table.status),
}));


export const invoiceItems = pgTable('invoice_items', {
    id: text('id').primaryKey().$defaultFn(() => crypto.randomUUID()),
    invoiceId: text('invoice_id').notNull().references(() => salesInvoices.id, { onDelete: 'cascade' }),
    finishedProductId: text('finished_product_id').notNull().references(() => finishedProducts.id),
    productName: text('product_name').notNull(),
    hsnCode: text('hsn_code').default('5608'),
    quantity: decimal('quantity', { precision: 10, scale: 2 }).notNull(),
    rate: decimal('rate', { precision: 10, scale: 2 }).notNull(),
    amount: decimal('amount', { precision: 12, scale: 2 }).notNull(),
    discountPercent: decimal('discount_percent', { precision: 5, scale: 2 }).default('0'),
    discountAmount: decimal('discount_amount', { precision: 10, scale: 2 }).default('0'),
    taxableAmount: decimal('taxable_amount', { precision: 12, scale: 2 }).notNull(),
    gstPercent: decimal('gst_percent', { precision: 5, scale: 2 }).default('18'),
    cgst: decimal('cgst', { precision: 10, scale: 2 }).default('0'),
    sgst: decimal('sgst', { precision: 10, scale: 2 }).default('0'),
    igst: decimal('igst', { precision: 10, scale: 2 }).default('0'),
    totalAmount: decimal('total_amount', { precision: 12, scale: 2 }).notNull(),
    createdAt: timestamp('created_at').defaultNow(),
});

// ==================== PAYMENTS ====================

export const paymentTransactions = pgTable('payment_transactions', {
    id: text('id').primaryKey().$defaultFn(() => crypto.randomUUID()),
    code: text('code').notNull().unique(),
    date: timestamp('date').notNull(),
    type: text('type').notNull(), // RECEIPT (from customer), PAYMENT (to supplier)
    referenceType: text('reference_type').notNull(), // purchase, sales
    referenceId: text('reference_id').notNull(),
    referenceCode: text('reference_code').notNull(),
    partyType: text('party_type').notNull(), // customer, supplier
    partyId: text('party_id').notNull(),
    partyName: text('party_name').notNull(),
    mode: text('mode').notNull(), // Cash, Bank, Cheque, UPI
    accountId: text('account_id').references(() => bankCashAccounts.id),
    amount: decimal('amount', { precision: 12, scale: 2 }).notNull(),
    bankReference: text('bank_reference'), // Cheque no, UTR, etc.
    remarks: text('remarks'),
    status: text('status').default('Completed'), // Completed, Reversed
    reversedBy: text('reversed_by'), // ID of the reversal transaction
    createdAt: timestamp('created_at').defaultNow(),
}, (table) => ({
    typeIdx: index('payment_transactions_type_idx').on(table.type),
    dateIdx: index('payment_transactions_date_idx').on(table.date),
    partyIdx: index('payment_transactions_party_idx').on(table.partyId),
}));

// ==================== STOCK MOVEMENTS (CORE LEDGER) ====================

export const stockMovements = pgTable('stock_movements', {
    id: text('id').primaryKey().$defaultFn(() => crypto.randomUUID()),
    date: timestamp('date').notNull(),
    movementType: text('movement_type').notNull(), // RAW_IN, RAW_OUT, FG_IN, FG_OUT, ADJUSTMENT
    itemType: text('item_type').notNull(), // raw_material, finished_product
    rawMaterialId: text('raw_material_id').references(() => rawMaterials.id),
    finishedProductId: text('finished_product_id').references(() => finishedProducts.id),
    quantityIn: decimal('quantity_in', { precision: 10, scale: 2 }).default('0'),
    quantityOut: decimal('quantity_out', { precision: 10, scale: 2 }).default('0'),
    runningBalance: decimal('running_balance', { precision: 10, scale: 2 }).default('0'),
    referenceType: text('reference_type').notNull(), // purchase, production, sales, adjustment
    referenceCode: text('reference_code').notNull(),
    referenceId: text('reference_id'),
    reason: text('reason').notNull(),
    createdAt: timestamp('created_at').defaultNow(),
}, (table) => ({
    rawMaterialIdx: index('stock_movements_raw_material_idx').on(table.rawMaterialId),
    finishedProductIdx: index('stock_movements_finished_product_idx').on(table.finishedProductId),
    itemTypeIdx: index('stock_movements_item_type_idx').on(table.itemType),
    dateIdx: index('stock_movements_date_idx').on(table.date),
}));

// ==================== ACCOUNTING & GENERAL LEDGER ====================

export const generalLedger = pgTable('general_ledger', {
    id: text('id').primaryKey().$defaultFn(() => crypto.randomUUID()),
    transactionDate: timestamp('transaction_date').notNull(),
    voucherNumber: text('voucher_number').notNull(), // RCPT-001, INV-001
    voucherType: text('voucher_type').notNull(), // INVOICE, RECEIPT, PAYMENT, JOURNAL, CONTRA
    ledgerId: text('ledger_id').notNull(), // References Customer, Supplier, Bank, etc. (Generic ID)
    ledgerType: text('ledger_type').notNull(), // CUSTOMER, SUPPLIER, BANK, CASH, INCOME, EXPENSE, TAX
    debitAmount: decimal('debit_amount', { precision: 12, scale: 2 }).default('0'),
    creditAmount: decimal('credit_amount', { precision: 12, scale: 2 }).default('0'),
    description: text('description'),
    referenceId: text('reference_id'), // ID of source doc (invoice id, payment id)
    isReversal: boolean('is_reversal').default(false),
    createdAt: timestamp('created_at').defaultNow(),
});

export const accountTransactions = pgTable('account_transactions', {
    id: text('id').primaryKey().$defaultFn(() => crypto.randomUUID()),
    date: timestamp('date').notNull(),
    accountId: text('account_id').notNull().references(() => bankCashAccounts.id),
    particular: text('particular').notNull(),
    referenceType: text('reference_type'), // purchase, sales, expense
    referenceCode: text('reference_code'),
    debit: decimal('debit', { precision: 12, scale: 2 }).default('0'),
    credit: decimal('credit', { precision: 12, scale: 2 }).default('0'),
    balance: decimal('balance', { precision: 12, scale: 2 }).notNull(),
    createdAt: timestamp('created_at').defaultNow(),
});

export const invoicePaymentAllocations = pgTable('invoice_payment_allocations', {
    id: text('id').primaryKey().$defaultFn(() => crypto.randomUUID()),
    paymentId: text('payment_id').notNull().references(() => paymentTransactions.id, { onDelete: 'cascade' }),
    invoiceId: text('invoice_id').notNull().references(() => salesInvoices.id, { onDelete: 'cascade' }),
    amount: decimal('amount', { precision: 12, scale: 2 }).notNull(),
    createdAt: timestamp('created_at').defaultNow(),
});

export const billPaymentAllocations = pgTable('bill_payment_allocations', {
    id: text('id').primaryKey().$defaultFn(() => crypto.randomUUID()),
    paymentId: text('payment_id').notNull().references(() => paymentTransactions.id, { onDelete: 'cascade' }),
    billId: text('bill_id').notNull().references(() => purchaseBills.id, { onDelete: 'cascade' }),
    amount: decimal('amount', { precision: 12, scale: 2 }).notNull(),
    createdAt: timestamp('created_at').defaultNow(),
});

export const expenses = pgTable('expenses', {
    id: text('id').primaryKey().$defaultFn(() => crypto.randomUUID()),
    code: text('code').notNull().unique(),
    date: timestamp('date').notNull(),
    expenseHeadId: text('expense_head_id').notNull().references(() => expenseHeads.id),
    description: text('description').notNull(),
    amount: decimal('amount', { precision: 12, scale: 2 }).notNull(),
    paymentMode: text('payment_mode').default('Bank'),
    accountId: text('account_id').references(() => bankCashAccounts.id),
    status: text('status').default('Paid'),
    createdAt: timestamp('created_at').defaultNow(),
});

// ==================== RELATIONS ====================

export const suppliersRelations = relations(suppliers, ({ many }) => ({
    purchaseBills: many(purchaseBills),
}));

export const rawMaterialsRelations = relations(rawMaterials, ({ many }) => ({
    purchaseBillItems: many(purchaseBillItems),
    productionBatches: many(productionBatches),
    stockMovements: many(stockMovements),
}));

export const finishedProductsRelations = relations(finishedProducts, ({ many }) => ({
    invoiceItems: many(invoiceItems),
    productionBatches: many(productionBatches),
    stockMovements: many(stockMovements),
}));

export const machinesRelations = relations(machines, ({ many }) => ({
    productionBatches: many(productionBatches),
}));

export const customersRelations = relations(customers, ({ many }) => ({
    salesInvoices: many(salesInvoices),
}));

export const purchaseBillsRelations = relations(purchaseBills, ({ one, many }) => ({
    supplier: one(suppliers, { fields: [purchaseBills.supplierId], references: [suppliers.id] }),
    items: many(purchaseBillItems),
    allocations: many(billPaymentAllocations),
}));

export const purchaseBillItemsRelations = relations(purchaseBillItems, ({ one }) => ({
    bill: one(purchaseBills, { fields: [purchaseBillItems.billId], references: [purchaseBills.id] }),
    rawMaterial: one(rawMaterials, { fields: [purchaseBillItems.rawMaterialId], references: [rawMaterials.id] }),
}));

export const productionBatchesRelations = relations(productionBatches, ({ one }) => ({
    machine: one(machines, { fields: [productionBatches.machineId], references: [machines.id] }),
    rawMaterial: one(rawMaterials, { fields: [productionBatches.rawMaterialId], references: [rawMaterials.id] }),
    finishedProduct: one(finishedProducts, { fields: [productionBatches.finishedProductId], references: [finishedProducts.id] }),
}));

export const salesInvoicesRelations = relations(salesInvoices, ({ one, many }) => ({
    customer: one(customers, { fields: [salesInvoices.customerId], references: [customers.id] }),
    items: many(invoiceItems),
    allocations: many(invoicePaymentAllocations),
}));

export const invoiceItemsRelations = relations(invoiceItems, ({ one }) => ({
    invoice: one(salesInvoices, { fields: [invoiceItems.invoiceId], references: [salesInvoices.id] }),
    finishedProduct: one(finishedProducts, { fields: [invoiceItems.finishedProductId], references: [finishedProducts.id] }),
}));

export const bankCashAccountsRelations = relations(bankCashAccounts, ({ many }) => ({
    transactions: many(accountTransactions),
    expenses: many(expenses),
    payments: many(paymentTransactions),
}));

export const accountTransactionsRelations = relations(accountTransactions, ({ one }) => ({
    account: one(bankCashAccounts, { fields: [accountTransactions.accountId], references: [bankCashAccounts.id] }),
}));

export const paymentTransactionsRelations = relations(paymentTransactions, ({ one, many }) => ({
    account: one(bankCashAccounts, { fields: [paymentTransactions.accountId], references: [bankCashAccounts.id] }),
    allocations: many(invoicePaymentAllocations),
    billAllocations: many(billPaymentAllocations),
}));

export const expenseHeadsRelations = relations(expenseHeads, ({ many }) => ({
    expenses: many(expenses),
}));

export const expensesRelations = relations(expenses, ({ one }) => ({
    expenseHead: one(expenseHeads, { fields: [expenses.expenseHeadId], references: [expenseHeads.id] }),
    account: one(bankCashAccounts, { fields: [expenses.accountId], references: [bankCashAccounts.id] }),
}));

export const stockMovementsRelations = relations(stockMovements, ({ one }) => ({
    rawMaterial: one(rawMaterials, { fields: [stockMovements.rawMaterialId], references: [rawMaterials.id] }),
    finishedProduct: one(finishedProducts, { fields: [stockMovements.finishedProductId], references: [finishedProducts.id] }),
}));

export const invoicePaymentAllocationsRelations = relations(invoicePaymentAllocations, ({ one }) => ({
    payment: one(paymentTransactions, { fields: [invoicePaymentAllocations.paymentId], references: [paymentTransactions.id] }),
    invoice: one(salesInvoices, { fields: [invoicePaymentAllocations.invoiceId], references: [salesInvoices.id] }),
}));

export const billPaymentAllocationsRelations = relations(billPaymentAllocations, ({ one }) => ({
    payment: one(paymentTransactions, { fields: [billPaymentAllocations.paymentId], references: [paymentTransactions.id] }),
    bill: one(purchaseBills, { fields: [billPaymentAllocations.billId], references: [purchaseBills.id] }),
}));

// ==================== ALIAS EXPORTS ====================
// For backward compatibility with route imports
export const invoices = salesInvoices;

